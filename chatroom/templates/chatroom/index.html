{% extends 'base.html' %}
{% load static %}
{% block title %}Chat Room{% endblock title %}

{% block content %}
<style>
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: linear-gradient(120deg, #f0f4f8, #e2e8f0); /* light gradient */
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
  }

  .chat-container {
    display: flex;
    justify-content: center;
    padding: 30px 10px;
    position: relative;
    z-index: 1;
  }

  .chat-wrapper {
    width: 100%;
    max-width: 700px;
    background: rgba(255,255,255,0.95);
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    overflow: hidden;
    position: relative;
    z-index: 2;
    animation: fadeIn 0.6s ease-out;
  }

  .chat-header {
    text-align: center;
    padding: 20px;
    background: #f8fafc; /* light header */
    color: #374151;
  }
  .chat-header h1 {
    margin: 0;
    font-size: 1.6rem;
  }
  .chat-header p {
    margin: 5px 0 0;
    font-size: 0.9rem;
  }

  .chat-box {
    height: 400px;
    overflow-y: auto;
    padding: 20px;
    background: #f8fafc;
    position: relative;
    z-index: 2;
  }

  .message-wrapper {
    display: flex;
    align-items: flex-start;
    margin-bottom: 15px;
  }
  .message-wrapper.own-message {
    flex-direction: row-reverse;
  }

  .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 10px;
    border: 2px solid white;
  }

  .message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 15px;
    background: white;
    color: #374151;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    word-wrap: break-word;
  }
  .own-message .message-bubble {
    background: #dbeafe; /* light blue bubble */
    color: #1e3a8a;
  }

  .message-header {
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: 5px;
  }
  .message-time {
    font-size: 0.7rem;
    opacity: 0.6;
    margin-top: 3px;
  }

  .message-form-container {
    padding: 15px 20px;
    background: #fff;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 10px;
  }

  .message-input {
    flex: 1;
    padding: 10px 15px;
    border-radius: 20px;
    border: 1px solid #ccc;
    outline: none;
    font-size: 0.9rem;
  }

  .send-button {
    padding: 10px 20px;
    border-radius: 20px;
    border: none;
    background: #60a5fa;
    color: white;
    font-weight: 600;
    cursor: pointer;
  }

  /* Floating bubbles for page background */
  .bg-bubbles {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
    z-index: 0;
  }
  .bg-bubbles .bubble {
    position: absolute;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    animation: float 8s infinite ease-in-out;
  }

  /* Floating bubbles inside chat wrapper */
  .bg-bubbles-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
    z-index: 1;
    border-radius: 20px;
  }
  .bg-bubbles-wrapper .bubble {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    animation: float 6s infinite ease-in-out;
  }

  @keyframes float {
    0% { transform: translateY(0) translateX(0); opacity:0.5; }
    50% { transform: translateY(-200px) translateX(20px); opacity:0.2; }
    100% { transform: translateY(0) translateX(-20px); opacity:0.5; }
  }

  @keyframes fadeIn { from {opacity:0} to {opacity:1} }
</style>

<div class="chat-container">
  <!-- Page bubbles -->
  <div class="bg-bubbles">
    {% for i in "1234567"|make_list %}
      {% with bubble_size=30|add:forloop.counter0 %}
        <div class="bubble" 
             style="
               width:{{ bubble_size }}px; 
               height:{{ bubble_size }}px; 
               left:{{ forloop.counter0|add:'5'|floatformat:0 }}%; 
               animation-delay:{{ forloop.counter0|add:'0.1'|floatformat:1 }}s;
             ">
        </div>
      {% endwith %}
    {% endfor %}
  </div>

  <div class="chat-wrapper">
    <!-- Bubbles inside chat wrapper -->
    <div class="bg-bubbles-wrapper">
      {% for i in "1234567"|make_list %}
        {% with bubble_size=20|add:forloop.counter0 %}
          <div class="bubble" 
               style="
                 width:{{ bubble_size }}px; 
                 height:{{ bubble_size }}px; 
                 left:{{ forloop.counter0|add:'5'|floatformat:0 }}%; 
                 top:{{ forloop.counter0|add:'10'|floatformat:0 }}%; 
                 animation-delay:{{ forloop.counter0|add:'0.1'|floatformat:1 }}s;
               ">
          </div>
        {% endwith %}
      {% endfor %}
    </div>

    <div class="chat-header">
      <h1>ðŸ’¬ Chat Room</h1>
      <p>Connect with your community</p>
    </div>

    <div class="chat-box" id="chatList">
      {% for chat in chats %}
        <div class="message-wrapper {% if chat.user == request.user %}own-message{% endif %}">
          <img class="avatar" 
               src="{% if chat.user.profile.image %}{{ chat.user.profile.image.url }}{% else %}{% static 'default-avatar.png' %}{% endif %}" 
               alt="{{ chat.user.username }}" title="{{ chat.user.username }}">
          <div class="message-bubble">
            <div class="message-header">{% if chat.user == request.user %}You{% else %}{{ chat.user.username }}{% endif %}</div>
            <p>{{ chat.message }}</p>
            <div class="message-time">{{ chat.created|timesince }} ago</div>
          </div>
        </div>
      {% empty %}
        <div style="text-align:center; padding:40px; color:#6b7280;">
          No messages yet. Start the conversation!
        </div>
      {% endfor %}
    </div>

    <div class="message-form-container">
      <form class="message-form" onsubmit="postChatMessage(event)">
        {% csrf_token %}
        <input type="text" id="messageInput" class="message-input" placeholder="Type your message..." autocomplete="off" required maxlength="500">
        <button type="submit" class="send-button">Send</button>
      </form>
    </div>
  </div>
</div>

<script>
function postChatMessage(event) {
    event.preventDefault();
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (!message) return;

    const chatList = document.getElementById('chatList');
    const wrapper = document.createElement('div');
    wrapper.className = 'message-wrapper own-message';
    wrapper.innerHTML = `
      <img class="avatar" src="{% if request.user.profile.image %}{{ request.user.profile.image.url }}{% else %}{% static 'default-avatar.png' %}{% endif %}" alt="You">
      <div class="message-bubble">
        <div class="message-header">You</div>
        <p>${message}</p>
        <div class="message-time">Just now</div>
      </div>
    `;
    chatList.appendChild(wrapper);
    chatList.scrollTop = chatList.scrollHeight;
    input.value = '';
}

document.addEventListener('DOMContentLoaded', () => {
    const chatList = document.getElementById('chatList');
    chatList.scrollTop = chatList.scrollHeight;

    document.getElementById('messageInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.querySelector('.message-form').dispatchEvent(new Event('submit'));
        }
    });
});
</script>
{% endblock %}
